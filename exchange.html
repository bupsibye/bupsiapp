<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–û–±–º–µ–Ω –ø–æ–¥–∞—Ä–∫–∞–º–∏</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --tg-bg: #fff;
      --tg-text: #000;
      --tg-secondary-bg: #f0f0f0;
    }
    body {
      font-family: -apple-system, sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--tg-bg);
      color: var(--tg-text);
      text-align: center;
    }
    .icon {
      font-size: 60px;
      margin: 20px 0;
    }
    h2 {
      margin: 0 0 10px;
    }
    p {
      color: #666;
      font-size: 14px;
      margin: 0 0 20px;
    }
    .btn {
      padding: 14px 24px;
      font-size: 16px;
      border: none;
      border-radius: 12px;
      margin: 0 5px;
      cursor: pointer;
    }
    .btn-accept {
      background: #00C853;
      color: white;
    }
    .btn-decline {
      background: #f44336;
      color: white;
    }
  </style>
</head>
<body>
  <div class="icon">üîÑ</div>
  <h2>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ–±–º–µ–Ω</h2>
  <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ–¥–ª–æ–∂–∏–ª –æ–±–º–µ–Ω—è—Ç—å—Å—è –ø–æ–¥–∞—Ä–∫–∞–º–∏</p>

  <div>
    <button class="btn btn-accept" onclick="acceptExchange()">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
    <button class="btn btn-decline" onclick="declineExchange()">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
  </div>

  <script>
    const tg = Telegram.WebApp;
    tg.ready();
    tg.expand();

    // –ü–æ–ª—É—á–∞–µ–º ID —Å–µ—Å—Å–∏–∏ –∏–∑ startapp
    const urlParams = new URLSearchParams(tg.initData);
    const startParam = urlParams.get('startapp'); // exchange_ex_123
    const sessionId = startParam?.replace('exchange_', '');

    if (!sessionId) {
      tg.showAlert?.('‚ùå –û—à–∏–±–∫–∞: —Å–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
      tg.close?.();
    }

    // –ö–Ω–æ–ø–∫–∞: –ø—Ä–∏–Ω—è—Ç—å –æ–±–º–µ–Ω
    async function acceptExchange() {
      try {
        const res = await fetch(`https://bupsiserver.onrender.com/api/accept-exchange/${sessionId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: tg.initDataUnsafe.user.id })
        });

        const result = await res.json();

        if (result.success) {
          tg.showAlert?.(`‚úÖ –û–±–º–µ–Ω –ø—Ä–∏–Ω—è—Ç! –ü–æ–ª—É—á–µ–Ω–æ ${result.stars} ‚≠ê`);
        } else {
          tg.showAlert?.(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`);
        }
      } catch (err) {
        tg.showAlert?.('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
      } finally {
        tg.close?.();
      }
    }

    // –ö–Ω–æ–ø–∫–∞: –æ—Ç–∫–ª–æ–Ω–∏—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º
    function declineExchange() {
      tg.showAlert?.('–í—ã –æ—Ç–∫–ª–æ–Ω–∏–ª–∏ –æ–±–º–µ–Ω');
      tg.close?.();
    }
  </script>
</body>
</html>
